<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
   <link rel="stylesheet" href="/libs/katex/katex.min.css">
     
   <link rel="stylesheet" href="/libs/highlight/github.min.css">
   
  <link rel="stylesheet" href="/css/franklin.css">
<link rel="stylesheet" href="/css/pure.css">
<link rel="stylesheet" href="/css/side-menu.css">
<!-- style adjustments -->
<style>
.franklin-content{padding-left:10%;}
@media (min-width: 940px) {
  .franklin-content {width: 640px; margin-left: 0px; padding-left: 80px;}
  .header {width: 700px;}
}
</style>
<link rel="icon" href="/assets/favicon.png">

   <title>Incremental construction</title>  
</head>
<body>
  <div id="layout">
    <!-- Menu toggle / hamburger icon -->
    <a href="#menu" id="menuLink" class="menu-link"><span></span></a>
    <div id="menu">
      <div class="pure-menu">
        <a class="pure-menu-heading" href="#">Menu</a>
        <ul class="pure-menu-list">
          <li class="pure-menu-item "><a href="/" class="pure-menu-link">Home</a></li>
          <li class="pure-menu-item "><a href="/tutorials/" class="pure-menu-link">Tutorials</a></li>
          <li class="pure-menu-item "><a href="/demos/" class="pure-menu-link">Demonstrations</a></li>
          <li class="pure-menu-item "><a href="/datasets/" class="pure-menu-link">Datasets</a></li>
          <li class="pure-menu-item "><a href="/tags/" class="pure-menu-link">Tags</a></li>
        </ul>
      </div>
    </div>
    <div id="main"> <!-- Closed in foot -->
      <div class="header">
        <h1>Incremental construction</h1>
        <h2>Usage demonstrations of `SimilaritySearch` with synthetic and real world data</h2>
      </div>


<!-- Content appended here -->
<div class="franklin-content"><div class="franklin-toc"><ol><li><a href="#incremental_construction_with_searchgraph">Incremental construction with <code>SearchGraph</code></a></li><li><a href="#dependencies">Dependencies</a></li><li><a href="#incremental_construction_with_searchgraph__2">Incremental construction with <code>SearchGraph</code></a></li><li><a href="#dependencies__2">Dependencies</a></li></ol></div>

<h2 id="incremental_construction_with_searchgraph__2"><a href="#incremental_construction_with_searchgraph__2" class="header-anchor">Incremental construction with <code>SearchGraph</code></a></h2>
<p>By Eric S. Téllez</p>
<pre><code class="language-julia">using SimilaritySearch</code></pre>
<p>For incremental construction we need a database backend that supports incremental insertions. Currently, there are two backends for this: <code>DynamicMatrixDatabase</code> and <code>VectorDatabase</code></p>
<ul>
<li><p><code>DynamicMatrixDatabase</code>: produces matrix like databases &#40;all objects having the same number of components&#41;</p>
</li>
<li><p><code>VectorDatabase</code>: A generic conainer of objects, objects can be of any kind</p>
</li>
</ul>
<pre><code class="language-julia">const dim &#61; 8

db &#61; DynamicMatrixDatabase&#40;Float32, dim&#41; # or VectorDatabase&#40;Vector&#123;Float32&#125;&#41;
dist &#61; L1Distance&#40;&#41;</code></pre><pre><code class="plaintext code-output">SimilaritySearch.L1Distance()</code></pre>
<p>it can use any distance function described in <code>SimilaritySearch</code> and <code>Distances.jl</code>, and in fact any <code>SemiMetric</code> as described in the later package. The index construction is made as follows</p>
<pre><code class="language-julia">G &#61; SearchGraph&#40;; dist, db&#41;</code></pre><pre><code class="plaintext code-output">SimilaritySearch.SearchGraph{SimilaritySearch.L1Distance, SimilaritySearch.DynamicMatrixDatabase{Float32, 8}, SimilaritySearch.BeamSearch}
  dist: SimilaritySearch.L1Distance SimilaritySearch.L1Distance()
  db: SimilaritySearch.DynamicMatrixDatabase{Float32, 8}
  links: Array{Vector{Int32}}((0,))
  locks: Array{Base.Threads.SpinLock}((0,))
  hints: Array{Int32}((0,)) Int32[]
  search_algo: SimilaritySearch.BeamSearch
  neighborhood: SimilaritySearch.Neighborhood
  verbose: Bool true
</code></pre>
<p>instead of <code>index&#33;</code> we can use <code>push&#33;</code> and <code>append&#33;</code> functions</p>
<pre><code class="language-julia">for _ in 1:10^4
    push&#33;&#40;G, rand&#40;Float32, dim&#41;&#41;  # push&#33; inserts one item at a time
end

append&#33;&#40;G, MatrixDatabase&#40;rand&#40;Float32, dim, 10^4&#41;&#41;&#41; # append&#33; inserts many items at once</code></pre><pre><code class="plaintext code-output">SearchModels> reached maximum number of iterations 16
SearchModels> reached maximum number of iterations 16
SearchModels> reached maximum number of iterations 16
SearchModels> reached maximum number of iterations 16
SearchModels> reached maximum number of iterations 16
SearchModels> reached maximum number of iterations 16
SearchModels> reached maximum number of iterations 16
SearchModels> reached maximum number of iterations 16
SearchModels> reached maximum number of iterations 16
SearchModels> reached maximum number of iterations 16
SearchModels> reached maximum number of iterations 16
SearchModels> reached maximum number of iterations 16
SearchModels> reached maximum number of iterations 16
SearchModels> reached maximum number of iterations 16
SearchModels> reached maximum number of iterations 16
SearchModels> reached maximum number of iterations 16
SearchModels> reached maximum number of iterations 16
(n, typeof(db), typeof(index.db), length(db), length(index.db), parallel_block) = (20000, SimilaritySearch.MatrixDatabase{Matrix{Float32}}, SimilaritySearch.DynamicMatrixDatabase{Float32, 8}, 10000, 20000, 1)
SearchModels> reached maximum number of iterations 16
SearchModels> reached maximum number of iterations 16
SimilaritySearch.SearchGraph{SimilaritySearch.L1Distance, SimilaritySearch.DynamicMatrixDatabase{Float32, 8}, SimilaritySearch.BeamSearch}
  dist: SimilaritySearch.L1Distance SimilaritySearch.L1Distance()
  db: SimilaritySearch.DynamicMatrixDatabase{Float32, 8}
  links: Array{Vector{Int32}}((20000,))
  locks: Array{Base.Threads.SpinLock}((20000,))
  hints: Array{Int32}((97,)) Int32[131, 355, 415, 580, 647, 651, 860, 864, 868, 959  …  3053, 3058, 3089, 3090, 3099, 3100, 3109, 3142, 3195, 3198]
  search_algo: SimilaritySearch.BeamSearch
  neighborhood: SimilaritySearch.Neighborhood
  verbose: Bool true
</code></pre>
<p>Note that we used a <code>MatrixDatabase</code> to wrap the matrix to be inserted since it will be copied into the index.</p>
<p>Now we have a populated index</p>
<pre><code class="language-julia">@assert length&#40;G&#41; &#61;&#61; 20_000</code></pre>
<p>this will display a lot of information in the console, since as construction advances the hyperparameters of the index are adjusted. The default optimization takes into account both quality and speed, and tries to adjust to take the best of both. See <code>ParetoRecall</code> in docs.</p>
<p>Once the index is created, the index can solve nearest neighbor queries</p>
<pre><code class="language-julia">Q &#61; MatrixDatabase&#40;rand&#40;dim, 30&#41;&#41;
k &#61; 5
I, D &#61; searchbatch&#40;G, Q, k&#41;
D</code></pre><pre><code class="plaintext code-output">5×30 Matrix{Float32}:
 0.664206  0.574841  0.510113  0.663577  0.613584  0.598138  0.505058  0.470343  0.600668  0.474441  0.600596  0.562695  0.563091  0.664981  0.595033  1.33941  0.584508  0.63288   0.579454  1.32854  0.526925  0.61723   0.590743  0.533075  0.520781  0.55406   0.518665  0.713035  0.60777   0.571485
 0.682431  0.604288  0.596871  0.670971  0.681005  0.646026  0.673284  0.562356  0.630455  0.571224  0.65131   0.719929  0.62182   0.805022  0.621761  1.4474   0.651448  0.654584  0.609576  1.33972  0.548276  0.785248  0.629803  0.650313  0.71771   0.627657  0.545808  0.83867   0.694093  0.618276
 0.68636   0.612285  0.769116  0.720326  0.684674  0.723656  0.721893  0.614765  0.7208    0.589835  0.704299  0.750309  0.663579  0.887765  0.760807  1.50594  0.687553  0.814929  0.673805  1.35053  0.616796  0.835531  0.644375  0.73394   0.720475  0.638987  0.572848  0.897476  0.717716  0.624061
 0.699576  0.659194  0.78991   0.760351  0.689761  0.772583  0.777655  0.745694  0.746939  0.670446  0.723986  0.806375  0.776619  0.929614  0.866454  1.51894  0.699727  0.959562  0.705064  1.39874  0.647527  0.86459   0.650219  0.796768  0.738405  0.66697   0.577541  0.913474  0.718522  0.686792
 0.709724  0.663471  0.82372   0.784842  0.733942  0.772976  0.822606  0.839673  0.762601  0.692087  0.741955  0.818806  0.780155  0.934848  0.871074  1.53998  0.705308  0.987845  0.709027  1.42142  0.653706  0.896861  0.656156  0.822278  0.747222  0.680774  0.602911  0.917489  0.749592  0.71989</code></pre>
<h2 id="dependencies__2"><a href="#dependencies__2" class="header-anchor">Dependencies</a></h2>
<pre><code class="plaintext code-output">      Status `~/Research/SimilaritySearchDemos/site-src/Project.toml`
  [053f045d] SimilaritySearch v0.8.11 `../../SimilaritySearch.jl`
</code></pre>

<div class="page-foot">
    <a href="http://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> Eric S. Tellez <eric.tellez@infotec.mx>. Last modified: March 14, 2022.
    Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>.
</div>
</div><!-- CONTENT ENDS HERE -->
      </div> <!-- end of id=main -->
  </div> <!-- end of id=layout -->
  <script src="/libs/pure/ui.min.js"></script>
  
      <script src="/libs/katex/katex.min.js"></script>
<script src="/libs/katex/auto-render.min.js"></script>
<script>renderMathInElement(document.body)</script>

  
  
      <script src="/libs/highlight/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();hljs.configure({tabReplace: '    '});</script>

  
</body>
</html>
